<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>TERMINAL_ROOT // ESPECTRO-CHAT</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
        :root { --green: #00ff41; --cyan: #00f3ff; --bg: #050505; --red: #ff3131; --yellow: #ffff00; }
        
        * { box-sizing: border-box; touch-action: manipulation; }
        html, body { height: 100%; margin: 0; padding: 0; background: var(--bg); color: var(--green); font-family: 'JetBrains Mono', monospace; overflow: hidden; }
        
        #main-chat { display: none; flex-direction: column; height: 100vh; height: -webkit-fill-available; width: 100%; }
        header { padding: 10px 15px; border-bottom: 1px solid #111; display: flex; justify-content: space-between; font-size: 11px; background: #000; flex-shrink: 0; }
        #messages { flex: 1; overflow-y: auto; padding: 15px; font-size: 14px; -webkit-overflow-scrolling: touch; }

        /* BARRA DE ESCRITURA */
        .input-area { padding: 10px; display: flex; gap: 8px; background: #000; border-top: 1px solid #222; flex-shrink: 0; padding-bottom: env(safe-area-inset-bottom, 10px); }
        input { flex: 1; background: #000; border: 1px solid #004400; color: #fff; padding: 12px; font-family: 'JetBrains Mono'; outline: none; font-size: 16px; border-radius: 0; }
        .btn { background: transparent; border: 1px solid var(--green); color: var(--green); padding: 0 20px; cursor: pointer; font-weight: bold; }

        /* VENTANA PRIVADA AJUSTABLE */
        #private-window { 
            position: fixed; 
            bottom: 80px; 
            right: 20px; 
            width: 320px; 
            height: 400px; 
            min-width: 250px; 
            min-height: 200px;
            max-width: 95vw;
            max-height: 80vh;
            background: #0a0a0a; 
            border: 1px solid var(--cyan); 
            display: none; 
            flex-direction: column; 
            z-index: 2000; 
            overflow: hidden;
            /* Permite ajustar el tamaño desde la esquina inferior derecha */
            resize: both; 
        }

        #private-header { background: #111; padding: 10px; display: flex; justify-content: space-between; color: var(--cyan); font-size: 10px; cursor: move; flex-shrink: 0; }
        #private-msgs { flex: 1; overflow-y: auto; padding: 10px; font-size: 13px; color: #fff; }
        .pvt-input-container { padding: 10px; background: #000; border-top: 1px solid #222; flex-shrink: 0; }

        /* Estilos de Mensajes */
        .admin-tag { color: var(--red); border: 1px solid var(--red); font-size: 9px; padding: 0 2px; margin-right: 5px; }
        .system-msg { color: var(--yellow); font-size: 13px; margin: 12px 0; border-left: 3px solid var(--yellow); padding-left: 10px; }
        .user-clickable { cursor: pointer; text-decoration: underline; }

        /* Loader y Overlays */
        #loader, #auth-overlay { position: fixed; inset: 0; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #000; }
        .auth-card { width: 100%; max-width: 320px; border: 1px solid var(--green); padding: 20px; }
    </style>
</head>
<body>

    <div id="loader">
        <div style="font-size: 10px;">CONECTANDO_AL_NODO...</div>
        <div style="width: 200px; height: 2px; background: #111; margin-top: 10px;">
            <div id="bar" style="width: 0%; height: 100%; background: var(--green); transition: 0.1s;"></div>
        </div>
    </div>

    <div id="auth-overlay" style="display:none;">
        <div class="auth-card">
            <h3 id="auth-title" style="color:var(--cyan)">// LOGIN</h3>
            <input type="text" id="user" placeholder="USUARIO" autocomplete="off">
            <input type="password" id="pass" placeholder="PASSWORD">
            <button class="btn" style="width:100%; margin-top:10px; height:45px;" onclick="procesarAcceso()">ENTRAR</button>
            <p onclick="cambiarModo()" id="modo-txt" style="font-size:10px; margin-top:15px; text-align:center; cursor:pointer;">¿NUEVO? REGISTRAR</p>
        </div>
    </div>

    <div id="main-chat">
        <header>
            <div>USUARIO: <span id="display-name" style="color:var(--cyan)">...</span></div>
            <div onclick="cerrarSesion()" style="color:var(--red); cursor:pointer;">[ SALIR ]</div>
        </header>
        <div id="messages"></div>
        <div class="input-area">
            <input type="text" id="msg-input" placeholder="Mensaje..." onkeypress="if(event.key==='Enter') enviar()">
            <button class="btn" onclick="enviar()">></button>
        </div>
    </div>

    <div id="private-window">
        <div id="private-header">
            <span id="private-target-name">PRIVADO</span>
            <span onclick="cerrarPrivado()" style="cursor:pointer">[X]</span>
        </div>
        <div id="private-msgs"></div>
        <div class="pvt-input-container">
            <input type="text" id="private-input" placeholder="Privado..." onkeypress="if(event.key==='Enter') enviarPrivado()">
        </div>
    </div>

    <script>
        const firebaseConfig = { 
            apiKey: "AIzaSyDpd6nFqhFZX9ucMdDe6m-YzW-L-HhJ_1E", 
            authDomain: "espectro-chat.firebaseapp.com", 
            databaseURL: "https://espectro-chat-default-rtdb.firebaseio.com", 
            projectId: "espectro-chat" 
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        let modoRegistro = false;
        let chatPrivadoCon = null;

        window.onload = () => {
            let p = 0;
            const interval = setInterval(() => {
                p += 25; document.getElementById('bar').style.width = p + '%';
                if(p >= 100) { clearInterval(interval); document.getElementById('loader').style.display = 'none'; actualizarInterfaz(); }
            }, 100);
        };

        function cambiarModo() {
            modoRegistro = !modoRegistro;
            document.getElementById('auth-title').innerText = modoRegistro ? "// REGISTRO" : "// LOGIN";
            document.getElementById('modo-txt').innerText = modoRegistro ? "YA TENGO CUENTA" : "¿NUEVO? REGISTRAR";
        }

        async function procesarAcceso() {
            const u = document.getElementById('user').value.trim().toLowerCase();
            const p = document.getElementById('pass').value;
            try {
                if(modoRegistro) {
                    await auth.createUserWithEmailAndPassword(u + "@terminal.local", p);
                    await db.ref('users/' + auth.currentUser.uid).set({ username: u, role: 'user', devId: btoa(navigator.userAgent).substring(0,20) });
                } else { await auth.signInWithEmailAndPassword(u + "@terminal.local", p); }
                location.reload();
            } catch(e) { alert("Acceso denegado"); }
        }

        async function enviar() {
            const inp = document.getElementById('msg-input');
            const val = inp.value.trim();
            if(!val) return;
            const snap = await db.ref('users/' + auth.currentUser.uid).once('value');
            const me = snap.val();
            if(!val.startsWith('/')) {
                db.ref('messages').push({ user: me.username, text: val, role: me.role || 'user' });
            }
            inp.value = '';
        }

        function abrirPrivado(target) {
            if(target.toUpperCase() === 'SISTEMA') return;
            chatPrivadoCon = target;
            document.getElementById('private-window').style.display = 'flex';
            const miNombre = document.getElementById('display-name').innerText.toLowerCase();
            const chatID = [miNombre, target.toLowerCase()].sort().join("_");
            db.ref('private_messages/' + chatID).on('value', snap => {
                const box = document.getElementById('private-msgs');
                box.innerHTML = '';
                snap.forEach(c => {
                    const esMio = c.val().from === miNombre;
                    box.innerHTML += `<p style="margin:5px 0"><b style="color:${esMio?'var(--green)':'var(--cyan)'}">${c.val().from.toUpperCase()}:</b> ${c.val().text}</p>`;
                });
                box.scrollTop = box.scrollHeight;
            });
        }

        function cerrarPrivado() { document.getElementById('private-window').style.display = 'none'; chatPrivadoCon = null; }

        async function enviarPrivado() {
            const inp = document.getElementById('private-input');
            const txt = inp.value.trim();
            if(!txt || !chatPrivadoCon) return;
            const miNombre = document.getElementById('display-name').innerText.toLowerCase();
            const chatID = [miNombre, chatPrivadoCon.toLowerCase()].sort().join("_");
            db.ref('private_messages/' + chatID).push({ from: miNombre, text: txt });
            inp.value = '';
        }

        function actualizarInterfaz() {
            auth.onAuthStateChanged(user => {
                if(user) {
                    db.ref('users/' + user.uid).on('value', s => {
                        document.getElementById('display-name').innerText = s.val().username.toUpperCase();
                        document.getElementById('auth-overlay').style.display = 'none';
                        document.getElementById('main-chat').style.display = 'flex';
                    });
                } else { document.getElementById('auth-overlay').style.display = 'flex'; }
            });
        }

        function cerrarSesion() { auth.signOut().then(() => location.reload()); }

        db.ref('messages').on('value', snap => {
            const box = document.getElementById('messages');
            box.innerHTML = '';
            snap.forEach(c => {
                const m = c.val();
                const div = document.createElement('div');
                div.style.marginBottom = "10px";
                if(m.user === 'SISTEMA') {
                    div.className = 'system-msg';
                    div.innerHTML = `<b>SISTEMA:</b> ${m.text || 'ALERTA DE SEGURIDAD'}`;
                } else {
                    const isAdmin = m.user === 'johan' || m.role === 'admin';
                    div.innerHTML = `${isAdmin?'<span class="admin-tag">ADMIN</span>':''}<b class="user-clickable" style="color:${isAdmin?'var(--cyan)':'#fff'}" onclick="abrirPrivado('${m.user}')">${m.user}:</b> ${m.text}`;
                }
                box.appendChild(div);
            });
            box.scrollTop = box.scrollHeight;
        });
    </script>
</body>
</html>
