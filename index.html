<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESPECTRO_TERMINAL // v2.0</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
        :root { --green: #00ff41; --cyan: #00f3ff; --bg: #050505; --dark-green: #002200; }

        * { box-sizing: border-box; cursor: crosshair !important; }
        body { background: var(--bg); color: var(--green); font-family: 'JetBrains Mono', monospace; margin: 0; height: 100vh; overflow: hidden; }

        /* FIX: ELIMINA EL CUADRO BLANCO DE OPERA/CHROME */
        input:-webkit-autofill, input:-webkit-autofill:hover, input:-webkit-autofill:focus {
            -webkit-text-fill-color: #fff !important;
            -webkit-box-shadow: 0 0 0px 1000px #081008 inset !important;
            transition: background-color 5000s ease-in-out 0s;
        }

        /* DISEÑO DE LA TERMINAL */
        #terminal-ui { display: flex; flex-direction: column; height: 100vh; border: 1px solid var(--dark-green); padding: 10px; }
        header { display: flex; justify-content: space-between; border-bottom: 1px solid var(--dark-green); padding-bottom: 5px; font-size: 12px; }
        
        #auth-screen { position: fixed; inset: 0; background: var(--bg); z-index: 1000; display: flex; align-items: center; justify-content: center; }
        .window { width: 400px; border: 1px solid var(--green); background: #000; padding: 30px; box-shadow: 0 0 20px rgba(0,255,65,0.1); }
        .tab { display: none; } .tab.active { display: block; }

        .input-line { margin-bottom: 20px; }
        label { display: block; font-size: 10px; margin-bottom: 5px; color: var(--cyan); }
        input { width: 100%; background: #000; border: none; border-bottom: 1px solid var(--dark-green); color: #fff; padding: 8px; font-family: 'JetBrains Mono'; outline: none; }
        input:focus { border-color: var(--green); }

        .btn { width: 100%; background: var(--green); color: #000; border: none; padding: 12px; font-weight: bold; text-transform: uppercase; letter-spacing: 2px; transition: 0.3s; }
        .btn:hover { background: #fff; box-shadow: 0 0 15px #fff; }

        #chat-area { flex: 1; overflow-y: auto; padding: 20px 0; }
        .msg { margin-bottom: 10px; font-size: 14px; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
        
        .footer-input { border-top: 1px solid var(--dark-green); padding-top: 10px; display: flex; gap: 10px; }
        #msg-input { flex: 1; border: 1px solid var(--dark-green); padding: 10px; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="window">
            <div id="login-tab" class="tab active">
                <h2 style="font-size: 14px; margin-bottom: 25px;">// ACCESO_SISTEMA</h2>
                <div class="input-line">
                    <label>ID_USUARIO</label>
                    <input type="text" id="l-user">
                </div>
                <div class="input-line">
                    <label>PASSWORD</label>
                    <input type="password" id="l-pass">
                </div>
                <button class="btn" onclick="login()">CONECTAR</button>
                <p style="font-size: 9px; margin-top: 20px; text-align: center; cursor: pointer; opacity: 0.5;" onclick="toggleTab('reg-tab')">NUEVO NODO? REGISTRAR</p>
            </div>

            <div id="reg-tab" class="tab">
                <h2 style="font-size: 14px; margin-bottom: 25px;">// CREAR_NODO</h2>
                <div class="input-line">
                    <label>USERNAME</label>
                    <input type="text" id="r-user">
                </div>
                <div class="input-line">
                    <label>PASSWORD</label>
                    <input type="password" id="r-p1">
                </div>
                <div class="input-line">
                    <label>CONFIRMAR_PASSWORD</label>
                    <input type="password" id="r-p2">
                </div>
                <button class="btn" onclick="register()">INICIALIZAR</button>
                <p style="font-size: 9px; margin-top: 20px; text-align: center; cursor: pointer; opacity: 0.5;" onclick="toggleTab('login-tab')">VOLVER AL ACCESO</p>
            </div>
        </div>
    </div>

    <div id="terminal-ui">
        <header>
            <div>CONECTADO // <span id="user-display" style="color:var(--cyan)">INVITADO</span></div>
            <div style="color:red; cursor:pointer;" onclick="logout()">[ DESCONECTAR ]</div>
        </header>

        <div id="chat-area"></div>

        <div class="footer-input">
            <span style="padding: 10px;">></span>
            <input type="text" id="msg-input" placeholder="Escribir comando..." onkeypress="if(event.key==='Enter') send()">
        </div>
    </div>

    <script>
        // CONFIGURACIÓN CON API KEY
        const firebaseConfig = {
            apiKey: "AIzaSyDpd6nFqhFZX9ucMdDe6m-YzW-L-HhJ_1E",
            authDomain: "espectro-chat.firebaseapp.com",
            databaseURL: "https://espectro-chat-default-rtdb.firebaseio.com",
            projectId: "espectro-chat"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        let myUser = null;

        function toggleTab(id) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        async function register() {
            const user = document.getElementById('r-user').value.trim();
            const p1 = document.getElementById('r-p1').value;
            const p2 = document.getElementById('r-p2').value;

            if(!user || p1.length < 6) return alert("Error: Datos insuficientes.");
            if(p1 !== p2) return alert("Error: Las contraseñas no coinciden.");

            const email = `${user.toLowerCase().replace(/\s/g, '')}@espectro.com`;

            try {
                const res = await auth.createUserWithEmailAndPassword(email, p1);
                await db.ref('users/' + res.user.uid).set({ username: user });
                location.reload();
            } catch(e) { alert("ERROR: Nodo ya ocupado o parámetros inválidos."); }
        }

        async function login() {
            const user = document.getElementById('l-user').value.trim();
            const pass = document.getElementById('l-pass').value;
            const email = `${user.toLowerCase().replace(/\s/g, '')}@espectro.com`;

            try { await auth.signInWithEmailAndPassword(email, pass); }
            catch(e) { alert("ERROR: Credenciales no válidas."); }
        }

        function logout() { auth.signOut().then(() => location.reload()); }

        function send() {
            const inp = document.getElementById('msg-input');
            if(inp.value.trim() && myUser) {
                db.ref('messages').push({ user: myUser.username, text: inp.value });
                inp.value = '';
            }
        }

        db.ref('messages').limitToLast(50).on('child_added', s => {
            const d = s.val();
            const msg = document.createElement('div');
            msg.className = 'msg';
            msg.innerHTML = `<span style="color:var(--cyan)">${d.user}:</span> <span style="color:#fff">${d.text}</span>`;
            const box = document.getElementById('chat-area');
            box.appendChild(msg);
            box.scrollTop = box.scrollHeight;
        });

        auth.onAuthStateChanged(async user => {
            if(user) {
                const snap = await db.ref('users/' + user.uid).once('value');
                myUser = snap.val();
                document.getElementById('user-display').innerText = myUser.username.toUpperCase();
                document.getElementById('auth-screen').style.display = 'none';
            } else {
                document.getElementById('auth-screen').style.display = 'flex';
            }
        });
    </script>
</body>
</html>
